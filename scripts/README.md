本ドキュメントはTokyoTyrantの冗長化に関して，サーバ構成，オペレーションを記述しています．

# 1.冗長化の設計前提

* マスター，スレーブサーバは固定とする（スレーブのマスター昇格は行わない）
* 同期はスレーブサーバの起動後に手動で行うものとする


# 2.構成

マスターサーバはデータファイルを配置するディレクトリが作成されていれば起動することができます．
同期はスレーブサーバからマスターサーバへ接続して行われるため，スレーブサーバにはデータファイルに加えて同期時刻保存ファイルおよび同期ログファイルが必要になります．ディレクトリの作成については，起動スクリプトを最初に実行した時点で自動的に作成されるため，作成作業は必要ありません．

#### マスターサーバ
<table>
  <tr>
    <th>Directory or File</th>
    <th>Description</th>
  </tr>
  <tr>
    <td>/etc/init.d/ttserver</td>
    <td>起動・停止用スクリプト</td>
  </tr>
  <tr>
    <td>/var/lib/tt/tt.tch</td>
    <td>データファイル</td>
  </tr>
  <tr>
    <td>/var/lib/tt/tt.log</td>
    <td>ログファイル</td>
  </tr>
</table>

#### スレーブサーバ
<table>
  <tr>
    <th>Directory or File</th>
    <th>Description</th>
  </tr>
  <tr>
    <td>/etc/init.d/ttserver</td>
    <td>起動・停止用スクリプト</td>
  </tr>
  <tr>
    <td>/var/lib/tt/tt.tch</td>
    <td>データファイル</td>
  </tr>
  <tr>
    <td>/var/lib/tt/tt.log</td>
    <td>ログファイル</td>
  </tr>
  <tr>
    <td>/var/lib/tt/rts</td>
    <td>同期時刻保存ファイル</td>
  </tr>
  <tr>
    <td>/var/lib/ulog</td>
    <td>更新ログディレクトリ</td>
  </tr>
</table>


# 3.基本オペレーション

マスター・スレーブサーバの起動手順と同期までの流れは以下の通りです．

(1)マスターの起動

 `# /etc/init.d/ttserver start`

(2)スレーブサーバでの同期時刻設定

 `# echo "0" > /var/lib/tt/rts`

同期を新規で開始する場合は，更新ログを待避しておく

 `# mv /var/lib/tt/ulog /var/lib/tt/ulog.old`


(3)スレーブの起動

 `# /etc/init.d/ttserver start`

(4)同期の開始

 `# /etc/init.d/ttserver start_repl`


# 4.障害対応

マスター，スレーブサーバに障害が発生した際は，以下の手順で復旧させることができます．

**1)スレーブサーバに障害が発生した場合**

マスターサーバを停止し，データファイルをスレーブサーバへコピーしてください．コピー後，3.基本オペレーションと同じ手順で復旧することができます．

**2)マスターサーバに障害が発生した場合**

スレーブサーバを停止し，データファイルをマスターサーバへコピーしてください．コピー後，3.基本オペレーションと同じ手順で復旧することができます．

**補足）**

サーバを停止させることなくデータファイルのバックアップコピーを作成することは"tcrmgr copy"コマンドで可能ですが，データのコピー中はすべてのデータにロックがかかるため，結果的にサービス停止してファイルコピーすることと変わりなく，障害復旧のための作業としては推奨できません．従って，本ドキュメントでは，いずれかのサーバに障害が発生し復旧が必要となった場合は，稼働中のサーバを停止しデータをコピーすることを推奨します．

以上